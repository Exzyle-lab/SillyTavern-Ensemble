<div id="ensemble_settings">
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>Ensemble</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">
            <div class="ensemble_settings_block">
                <label class="checkbox_label" for="ensemble_enabled">
                    <input type="checkbox" id="ensemble_enabled" data-setting="enabled">
                    <span>Enable Ensemble</span>
                </label>
                <small class="notes">Enable parallel NPC generation via function calling</small>
            </div>

            <hr>

            <h4 class="margin0">Tier Profile Chains</h4>
            <small class="notes">Configure fallback chains for each tier. First profile is primary; subsequent profiles are fallbacks if rate-limited or unavailable. Drag to reorder.</small>

            <div class="ensemble_tier_settings">
                <!-- Orchestrator Tier -->
                <div class="ensemble_tier_row" data-tier="orchestrator">
                    <label>
                        <span class="ensemble_tier_label">Orchestrator</span>
                        <small class="notes">GM/Narrator, narrative coherence</small>
                    </label>
                    <div class="ensemble_fallback_chain">
                        <div class="ensemble_profile_list" data-tier="orchestrator">
                            <!-- Profile tags inserted here by JS -->
                        </div>
                        <div class="ensemble_add_profile">
                            <select class="ensemble_profile_select text_pole" data-tier="orchestrator" title="Add profile to chain">
                                <option value="">+ Add Profile</option>
                            </select>
                        </div>
                    </div>
                    <small class="ensemble_chain_hint notes">No profiles configured - will use current active profile</small>
                </div>

                <!-- Major Tier -->
                <div class="ensemble_tier_row" data-tier="major">
                    <label>
                        <span class="ensemble_tier_label">Major</span>
                        <small class="notes">Key NPCs with complex backstories</small>
                    </label>
                    <div class="ensemble_fallback_chain">
                        <div class="ensemble_profile_list" data-tier="major">
                            <!-- Profile tags inserted here by JS -->
                        </div>
                        <div class="ensemble_add_profile">
                            <select class="ensemble_profile_select text_pole" data-tier="major" title="Add profile to chain">
                                <option value="">+ Add Profile</option>
                            </select>
                        </div>
                    </div>
                    <small class="ensemble_chain_hint notes">No profiles configured - will use current active profile</small>
                </div>

                <!-- Standard Tier -->
                <div class="ensemble_tier_row" data-tier="standard">
                    <label>
                        <span class="ensemble_tier_label">Standard</span>
                        <small class="notes">Moderate complexity NPCs</small>
                    </label>
                    <div class="ensemble_fallback_chain">
                        <div class="ensemble_profile_list" data-tier="standard">
                            <!-- Profile tags inserted here by JS -->
                        </div>
                        <div class="ensemble_add_profile">
                            <select class="ensemble_profile_select text_pole" data-tier="standard" title="Add profile to chain">
                                <option value="">+ Add Profile</option>
                            </select>
                        </div>
                    </div>
                    <small class="ensemble_chain_hint notes">No profiles configured - will use current active profile</small>
                </div>

                <!-- Minor Tier -->
                <div class="ensemble_tier_row" data-tier="minor">
                    <label>
                        <span class="ensemble_tier_label">Minor</span>
                        <small class="notes">Shopkeepers, thugs, one-offs</small>
                    </label>
                    <div class="ensemble_fallback_chain">
                        <div class="ensemble_profile_list" data-tier="minor">
                            <!-- Profile tags inserted here by JS -->
                        </div>
                        <div class="ensemble_add_profile">
                            <select class="ensemble_profile_select text_pole" data-tier="minor" title="Add profile to chain">
                                <option value="">+ Add Profile</option>
                            </select>
                        </div>
                    </div>
                    <small class="ensemble_chain_hint notes">No profiles configured - will use current active profile</small>
                </div>

                <!-- Utility Tier -->
                <div class="ensemble_tier_row" data-tier="utility">
                    <label>
                        <span class="ensemble_tier_label">Utility</span>
                        <small class="notes">Judge, Archivist, Guardian agents</small>
                    </label>
                    <div class="ensemble_fallback_chain">
                        <div class="ensemble_profile_list" data-tier="utility">
                            <!-- Profile tags inserted here by JS -->
                        </div>
                        <div class="ensemble_add_profile">
                            <select class="ensemble_profile_select text_pole" data-tier="utility" title="Add profile to chain">
                                <option value="">+ Add Profile</option>
                            </select>
                        </div>
                    </div>
                    <small class="ensemble_chain_hint notes">No profiles configured - will use current active profile</small>
                </div>
            </div>

            <hr>

            <div class="ensemble_settings_block">
                <label class="checkbox_label" for="ensemble_debug">
                    <input type="checkbox" id="ensemble_debug" data-setting="debug">
                    <span>Debug Logging</span>
                </label>
                <small class="notes">Enable verbose console logging for troubleshooting</small>
            </div>

            <div class="ensemble_action_buttons">
                <div id="ensemble_refresh_profiles" class="menu_button menu_button_icon">
                    <i class="fa-solid fa-sync"></i>
                    <span>Refresh Profiles</span>
                </div>
                <div id="ensemble_inspect_tiers" class="menu_button menu_button_icon">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <span>Inspect Tiers</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template for profile tag (used by JS) -->
<template id="ensemble_profile_tag_template">
    <div class="ensemble_profile_tag" draggable="true" data-profile="">
        <span class="ensemble_profile_order"></span>
        <i class="ensemble_drag_handle fa-solid fa-grip-vertical" title="Drag to reorder"></i>
        <span class="ensemble_profile_name"></span>
        <i class="ensemble_profile_remove fa-solid fa-times" title="Remove from chain"></i>
    </div>
</template>
